generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ────────────────────────────────────────────

enum Role {
  STUDENT
  TPO          // ADMIN_TPO
  SUPER_ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Category {
  GENERAL
  OBC
  SC
  ST
  EWS
  OTHER
}

enum OpportunityType {
  INTERNSHIP
  FULLTIME
}

enum OpportunityStatus {
  OPEN
  CLOSED
}

enum ApplicationStatus {
  APPLIED
  SHORTLISTED
  ROUND1
  ROUND2
  OFFERED
  REJECTED
}

enum RoundType {
  APTITUDE
  TECHNICAL
  HR
  GD
}

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum AnnouncementVisibility {
  ALL
  STUDENTS
  ADMINS
}

enum PlacementType {
  ON_CAMPUS
  OFF_CAMPUS
}

// ─── Models ───────────────────────────────────────────

model Institution {
  id        String   @id @default(cuid())
  name      String
  domain    String   @unique
  address   String?
  logo      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users           User[]
  studentProfiles StudentProfile[]
  opportunities   Opportunity[]
  announcements   Announcement[]

  @@map("institutions")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  role          Role
  phone         String?
  avatar        String?
  isActive      Boolean  @default(true)
  isApproved    Boolean  @default(false)
  institutionId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  institution          Institution      @relation(fields: [institutionId], references: [id])
  studentProfile       StudentProfile?
  notifications        Notification[]
  createdOpportunities Opportunity[]    @relation("CreatedByTPO")
  announcements        Announcement[]

  @@index([institutionId])
  @@index([email])
  @@index([role])
  @@map("users")
}

model StudentProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  institutionId String

  // Personal
  fullName          String?
  gender            Gender?
  dob               DateTime?
  personalEmail     String?
  phone             String?
  alternatePhone    String?
  address           String?
  city              String?
  state             String?
  pincode           String?
  category          Category?
  nationality       String?   @default("Indian")

  // 10th
  tenthBoard        String?
  tenthYear         Int?
  tenthPercentage   Float?

  // 12th
  twelfthBoard      String?
  twelfthYear       Int?
  twelfthPercentage Float?

  // Graduation
  enrollmentNo      String
  course            String
  branch            String
  specialization    String?
  semester          Int?
  cgpa              Float?
  graduationYear    Int
  activeBacklogs    Int       @default(0)
  backlogHistory    Int       @default(0)

  // Professional
  skills            Json?     @default("[]")
  certifications    Json?     @default("[]")
  internships       Json?     @default("[]")
  projects          Json?     @default("[]")
  linkedin          String?
  github            String?

  // Documents
  resumeUrl              String?
  photoUrl               String?
  tenthMarksheetUrl      String?
  twelfthMarksheetUrl    String?
  graduationMarksheetUrl String?

  // Placement status
  isPlaced        Boolean        @default(false)
  placedCompany   String?
  placedCTC       String?
  placedRole      String?
  placementType   PlacementType?
  offerLetterUrl  String?

  // Profile flags
  isProfileComplete Boolean  @default(false)
  isProfileLocked   Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  institution  Institution         @relation(fields: [institutionId], references: [id])
  applications Application[]
  interviews   InterviewSchedule[]

  @@index([institutionId])
  @@index([branch])
  @@index([cgpa])
  @@index([graduationYear])
  @@index([enrollmentNo])
  @@map("student_profiles")
}

model Opportunity {
  id              String            @id @default(cuid())
  institutionId   String
  companyName     String
  roleTitle       String
  type            OpportunityType
  location        String?
  ctc             String?
  description     String?
  lastDateToApply DateTime
  status          OpportunityStatus @default(OPEN)
  createdByTpoId  String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  institution  Institution          @relation(fields: [institutionId], references: [id])
  createdBy    User                 @relation("CreatedByTPO", fields: [createdByTpoId], references: [id])
  eligibility  EligibilityCriteria?
  applications Application[]
  rounds       RecruitmentRound[]

  @@index([institutionId])
  @@index([status])
  @@index([type])
  @@map("opportunities")
}

model EligibilityCriteria {
  id                   String  @id @default(cuid())
  opportunityId        String  @unique
  minCGPA              Float?
  allowedBranches      Json?   // JSON string array
  maxActiveBacklogs    Int?
  minTenthPercentage   Float?
  minTwelfthPercentage Float?
  graduationYear       Int?

  opportunity Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@map("eligibility_criteria")
}

model Application {
  id            String            @id @default(cuid())
  opportunityId String
  studentId     String
  status        ApplicationStatus @default(APPLIED)
  currentRound  Int?
  appliedAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  opportunity    Opportunity    @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  studentProfile StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, opportunityId])
  @@index([opportunityId])
  @@index([status])
  @@map("applications")
}

model RecruitmentRound {
  id            String    @id @default(cuid())
  opportunityId String
  roundName     String
  roundType     RoundType
  roundOrder    Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  opportunity Opportunity         @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  interviews  InterviewSchedule[]

  @@unique([opportunityId, roundOrder])
  @@index([opportunityId])
  @@map("recruitment_rounds")
}

model InterviewSchedule {
  id          String          @id @default(cuid())
  roundId     String
  studentId   String
  scheduledAt DateTime
  meetingLink String?
  status      InterviewStatus @default(SCHEDULED)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  round          RecruitmentRound @relation(fields: [roundId], references: [id], onDelete: Cascade)
  studentProfile StudentProfile   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([roundId])
  @@index([studentId])
  @@map("interview_schedules")
}

model Announcement {
  id            String                  @id @default(cuid())
  institutionId String
  title         String
  description   String
  createdById   String
  visibleTo     AnnouncementVisibility  @default(ALL)
  isPinned      Boolean                 @default(false)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt

  institution Institution @relation(fields: [institutionId], references: [id])
  createdBy   User        @relation(fields: [createdById], references: [id])

  @@index([institutionId])
  @@index([visibleTo])
  @@map("announcements")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  isRead    Boolean  @default(false)
  linkUrl   String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}
